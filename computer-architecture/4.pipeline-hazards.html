<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Pipeline Hazards - Notes</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../microprocessors/index.html"><strong aria-hidden="true">1.</strong> Microprocessors</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../microprocessors/history.html"><strong aria-hidden="true">1.1.</strong> History</a></li><li class="chapter-item expanded "><a href="../microprocessors/index.html"><strong aria-hidden="true">1.2.</strong> 8086 Microprocessor</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../microprocessors/architecture.html"><strong aria-hidden="true">1.2.1.</strong> Architecture</a></li><li class="chapter-item expanded "><a href="../microprocessors/addressing-modes.html"><strong aria-hidden="true">1.2.2.</strong> Addressing Modes</a></li><li class="chapter-item expanded "><a href="../microprocessors/registors-and-flags.html"><strong aria-hidden="true">1.2.3.</strong> Registers and Flags</a></li><li class="chapter-item expanded "><a href="../microprocessors/memory-segmentation.html"><strong aria-hidden="true">1.2.4.</strong> Memory Segmentation</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../computer-architecture/index.html"><strong aria-hidden="true">2.</strong> Computer Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../computer-architecture/1.intro.html"><strong aria-hidden="true">2.1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../computer-architecture/2.performance-measurement.html"><strong aria-hidden="true">2.2.</strong> Performance Measurement</a></li><li class="chapter-item expanded "><a href="../computer-architecture/3.intro-to-risc.html"><strong aria-hidden="true">2.3.</strong> Intro to RISC</a></li><li class="chapter-item expanded "><a href="../computer-architecture/4.pipeline-hazards.html" class="active"><strong aria-hidden="true">2.4.</strong> Pipeline Hazards</a></li><li class="chapter-item expanded "><a href="../computer-architecture/6.compiler-techniques.html"><strong aria-hidden="true">2.5.</strong> Compiler Techniques</a></li></ol></li><li class="chapter-item expanded "><a href="../questions/index.html"><strong aria-hidden="true">3.</strong> Interview Questions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../questions/cpp.html"><strong aria-hidden="true">3.1.</strong> C++</a></li><li class="chapter-item expanded "><a href="../questions/summer-dsa-plan.html"><strong aria-hidden="true">3.2.</strong> Summer DSA Plan</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Notes</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="pipeline-hazards"><a class="header" href="#pipeline-hazards">Pipeline Hazards</a></h1>
<ul>
<li>Hazards: circumstances that would cause incorrect execution if next
instruction is fetched and executed</li>
<li><strong>Structural hazards:</strong> Different instructions, at different stages, in the
pipeline want to use the same hardware resource</li>
<li><strong>Data hazards:</strong> An instruction in the pipeline requires data to be computed by
a previous instruction still in the pipeline</li>
<li><strong>Control hazards:</strong> Succeeding instruction, to put into pipeline, depends on the
outcome of a previous branch instruction, already in pipeline</li>
</ul>
<h2 id="structural-hazard"><a class="header" href="#structural-hazard">Structural Hazard</a></h2>
<ul>
<li>
<p>Eliminate the use same hardware for two different things at the same time</p>
</li>
<li>
<p>Solution 1: Wait</p>
<ul>
<li>must detect the hazard</li>
<li>must have mechanism to stall</li>
</ul>
</li>
<li>
<p>Solution 2: Duplicate hardware</p>
<ul>
<li>Multiple such units will help both instruction to progress
<img src="./images/eliminating-structural-hazard.png" alt="Eliminating Structural Hazard" /> </li>
</ul>
</li>
</ul>
<h2 id="data-hazard"><a class="header" href="#data-hazard">Data Hazard</a></h2>
<h3 id="read-after-writeraw"><a class="header" href="#read-after-writeraw">Read After Write(RAW)</a></h3>
<ul>
<li>Instr-2 tries to read operand before Instr-1, writes it
<pre><code>Instr-1: add r1,r2,r3
Instr-2: sub r4,r1,r3
</code></pre>
</li>
</ul>
<h3 id="write-after-read-war"><a class="header" href="#write-after-read-war">Write After Read (WAR)</a></h3>
<ul>
<li>Instr-2, writes operand before Instr-1, reads it
<pre><code>Instr-1: sub r4,r1,r3
Instr-2: add r1,r2,r3
Instr-3: mul r6,r1,r7
</code></pre>
</li>
<li>Called an anti-dependence by compiler writers.</li>
<li>This results from reuse of the name r1</li>
<li>Can’t happen in MIPS 5 stage pipeline because:
<ul>
<li>All instructions take 5 stages, and</li>
<li>Reads are always in stage 2, and</li>
<li>Writes are always in stage 5</li>
</ul>
</li>
</ul>
<h3 id="write-after-write-waw"><a class="header" href="#write-after-write-waw">Write After Write (WAW)</a></h3>
<ul>
<li>Instr-2, writes operand before Instr-1, writes it.
<pre><code>Instr-1: sub r1,r4,r3
Instr-2: add r1,r2,r3
Instr-3: mul r6,r1,r7
</code></pre>
</li>
<li>Called an output dependence</li>
<li>This also results from the reuse of name r1</li>
<li>Can’t happen in MIPS 5 stage pipeline because:
<ul>
<li>All instructions take 5 stages, and</li>
<li>Writes are always in stage 5</li>
</ul>
</li>
<li>WAR and WAW happens in out of order pipes</li>
</ul>
<h3 id="handle-data-hazards"><a class="header" href="#handle-data-hazards">Handle Data hazards</a></h3>
<ul>
<li>Data hazard: instruction needs data from the result of a previous
instruction still executing in pipeline</li>
<li>Solution: Forward data if possible</li>
</ul>
<p><img src="./images/data-forwarding.png" alt="Data Forwarding" /> </p>
<ul>
<li>Load ALU Hazard</li>
<li>Solution: Delay the next instruction (add bubble)</li>
<li>Software Solution: Arrange the instructions while compiling to avoid hazard</li>
</ul>
<h2 id="control-hazard"><a class="header" href="#control-hazard">Control Hazard</a></h2>
<ul>
<li>Normal MIPS Pipeline
<img src="./images/conventional-mips-pipeline.png" alt="Normal" /> </li>
<li>Modern MIPS Pipeline
<img src="./images/modern-mips-pipeline.png" alt="Modern" /> </li>
</ul>
<h3 id="four-branch-hazard-alternatives"><a class="header" href="#four-branch-hazard-alternatives">Four Branch Hazard Alternatives</a></h3>
<h4 id="1-stall-until-branch-direction-is-clear"><a class="header" href="#1-stall-until-branch-direction-is-clear">1: Stall until branch direction is clear</a></h4>
<h4 id="2-predict-branch-not-taken"><a class="header" href="#2-predict-branch-not-taken">2: Predict Branch Not Taken</a></h4>
<ul>
<li>Execute successor instructions in sequence</li>
<li>&quot;Squash&quot; instructions in pipeline if branch actually taken</li>
</ul>
<h4 id="3-predict-branch-taken"><a class="header" href="#3-predict-branch-taken">3: Predict Branch Taken</a></h4>
<ul>
<li>But branch target address in is not known by IF stage</li>
<li>Target is known at same time as branch outcome (IDstage)</li>
<li>MIPS still incurs 1 cycle branch penalty</li>
</ul>
<h4 id="4-delayed-branch"><a class="header" href="#4-delayed-branch">4: Delayed Branch</a></h4>
<ul>
<li>Define branch to take place AFTER one instruction following the branch
instruction</li>
<li>1 slot delay allows proper decision and branch target address in 5 stage
pipeline (MIPS uses this approach)</li>
<li>Where to get instructions to fill branch delay slot?
<img src="./images/filling-branch-delay-slot.png" alt="bds" /> </li>
</ul>
<h2 id="conditional-branches"><a class="header" href="#conditional-branches">Conditional Branches</a></h2>
<ul>
<li>When do you know you have a branch?
<ul>
<li>During ID cycle (Could you know before that?)</li>
</ul>
</li>
<li>When do you know if the branch is Taken or Not-Taken
<ul>
<li>During EXE cycle/ ID stage depending on the design</li>
</ul>
</li>
<li>We need for sophisticated solutions for following cases
<ul>
<li>Modern pipelines are deep ( 10 + stages)</li>
<li>Several instructions issued/cycle</li>
<li>Several predicted branches in-flight at the same time</li>
</ul>
</li>
</ul>
<h2 id="dynamic-branch-prediction"><a class="header" href="#dynamic-branch-prediction">Dynamic branch prediction</a></h2>
<ul>
<li>
<p>Execution of a branch requires knowledge of:</p>
</li>
<li>
<p>Branch instruction - encode whether instruction is a branch or not. Decide on
taken or not taken (i.e., prediction can be done at IF stage)</p>
</li>
<li>
<p>Whether the branch is Taken/Not-Taken (hence a branch prediction mechanism)</p>
</li>
<li>
<p>If the branch is taken what is the target address (can be computed but can
also be &quot;precomputed&quot;, i.e., stored in some table)</p>
</li>
<li>
<p>If the branch is taken what is the instruction at the branch target address
(saves the fetch cycle for that instruction)</p>
</li>
<li>
<p>Use a <strong>Branch Prediction Buffer(BPB)</strong></p>
<ul>
<li>Also called Branch Prediction Table (BPT), Branch History Table (BHT)</li>
<li>Records previous outcomes of the branch instruction</li>
<li>How to index into the table is an issue</li>
</ul>
</li>
<li>
<p>A prediction using BPB is attempted when the branch instruction is fetched
(IF stage or equivalent)</p>
</li>
<li>
<p>It is acted upon during ID stage (when we know we have a branch)</p>
</li>
<li>
<p>Has a prediction been made (Y/N)</p>
<ul>
<li>If not use default &quot;Not Taken&quot;</li>
</ul>
</li>
<li>
<p>Is it correct or incorrect ?</p>
</li>
<li>
<p>Two cases:</p>
<ul>
<li>Case 1: Yes and the prediction was correct (known at ID stage) or No but
the default was correct: No delay</li>
<li>Case 2: Yes and the prediction was incorrect or No and the default was
incorrect: Delay</li>
</ul>
</li>
</ul>
<h3 id="prediction-scheme-with-1-or-2-bit-fsm"><a class="header" href="#prediction-scheme-with-1-or-2-bit-fsm">Prediction Scheme with 1 or 2 bit FSM</a></h3>
<p><img src="./images/prediction-1-bit.png" alt="prediction-1-bit" />
<img src="./images/prediction-2-bit.png" alt="prediction-2-bit" /> </p>
<ul>
<li>The use of a 2-bit predictor will allow branches that favor taken (or not
taken) to be mispredicted less often than the one-bit case. (reinforcement
learning)</li>
</ul>
<h3 id="branch-prediction-in-hardware"><a class="header" href="#branch-prediction-in-hardware">Branch Prediction In Hardware</a></h3>
<ul>
<li>Branch prediction is extremely useful in loops.</li>
<li>A simple branch prediction can be implemented using a small amount of memory
indexed by lower order bits of the address of the branch instruction. (branch
prediction buffer)</li>
<li>One bit stores whether the branch was taken or not</li>
<li>The next time the branch instruction is fetched refer this bit</li>
</ul>
<h3 id="advanced-branch-prediction-techniques"><a class="header" href="#advanced-branch-prediction-techniques">Advanced Branch Prediction Techniques</a></h3>
<h4 id="basic-2-bit-predictor"><a class="header" href="#basic-2-bit-predictor">Basic 2-bit predictor:</a></h4>
<ul>
<li>For each branch:- Predict T or NT</li>
<li>If the prediction is wrong for two consecutive times, change prediction</li>
</ul>
<h4 id="correlating-predictor"><a class="header" href="#correlating-predictor">Correlating predictor:</a></h4>
<ul>
<li>Multiple 2-bit predictors for each branch</li>
<li>One for each possible combination of outcomes of preceding n branches</li>
</ul>
<pre><code>if(x==2)  /*br-1*/
x=0;
if(y==2)  /*br-2*/
y=0;
if(x!=y)  /*br-3*/
    do this
else do that
</code></pre>
<h4 id="local-predictor"><a class="header" href="#local-predictor">Local predictor</a></h4>
<ul>
<li>Multiple 2-bit predictors for each branch</li>
<li>One for each possible combination of outcomes for the last n occurrences of this branch</li>
</ul>
<h4 id="tournament-predictor"><a class="header" href="#tournament-predictor">Tournament predictor</a></h4>
<ul>
<li>Combine correlating predictor with local predictor</li>
</ul>
<h2 id="branch-target-buffer"><a class="header" href="#branch-target-buffer">Branch-Target Buffer</a></h2>
<ul>
<li>To reduce the branch penalty, know whether the as-yet-un-decoded instruction is a branch. If so, what the next program counter (PC) should be</li>
<li>If the instruction is a branch and we know what the next PC should be, we can have a branch penalty of zero</li>
<li>A branch-prediction cache that stores the predicted address for the next instruction after a branch is called a branch-target buffer (BTB) or branch-target cache.
<img src="./images/branch-target-buffer.png" alt="branch-target-buffer" /> 
<img src="./images/branch-target-buffer-1.png" alt="branch-target-buffer-1" /> </li>
</ul>
<h2 id="branch-folding"><a class="header" href="#branch-folding">Branch Folding</a></h2>
<ul>
<li>Optimization on BTB to make zero cycle branch 
<ul>
<li>Larger branch-target buffer- store one or more target instructions</li>
<li>Add target instruction into BTB to deal with longer decoding time required by larger buffer</li>
<li>Branch folding can be used to obtain 0-cycle unconditional branches and sometimes 0-cycle conditional branches</li>
</ul>
</li>
</ul>
<h1 id="questions"><a class="header" href="#questions">Questions</a></h1>
<h2 id="example-1"><a class="header" href="#example-1">Example 1</a></h2>
<p>Given a non-pipelined architecture running at 1.5 GHz, that takes 5 cycles to
finish an instruction. You want to make it pipelined with 5 stages. Due to
hardware overhead the pipelined design will operate only at 1 GHz. 5% of memory
instructions cause a stall of 50 cycles, 30% of branch instruction cause a
stall of 2 cycles and load-ALU combinations cause a stall of 1 cycle. Assume
that in a given program, there exist 20% of branch instructions and 30% of
memory instructions. 10% of instructions are load-ALU combinations. What is the
speedup of pipelined design over the non-pipelined design?</p>
<p>Ans:
<img src="./images/pipeline-hazards-solution1.png" alt="pipeline hazard soution 1" /> </p>
<h2 id="example-2"><a class="header" href="#example-2">Example 2</a></h2>
<p>A program has 2000 instructions in the sequence L.D, ADD.D, L.D, ADD.D,.....
L.D, ADD.D. The ADD.D instruction depends on the L.D instruction right before
it. The L.D instruction depends on the ADD.D instruction right before it. If
the program is executed on the 5-stage pipeline what would be the actual CPI
with and without operand forwarding technique?</p>
<p>Ans:
<img src="./images/pipeline-hazards-solution2.1.png" alt="pipeline hazard soution 2" /> 
<img src="./images/pipeline-hazards-solution2.2.png" alt="pipeline hazard soution 2" /> </p>
<h2 id="example-3-branch-prediction"><a class="header" href="#example-3-branch-prediction">Example 3: Branch Prediction</a></h2>
<p>Consider the last 16 actual outcomes of a single static branch. T means branch
is taken and N means not taken.</p>
<p>{oldest&gt; TTNNTNTTTNTNTTNT &lt; latest}</p>
<p>A two level branch predictor of (1,2) type is used. Since there is only one
branch in the program indexing to BHT with PC is irrelevant. Hence only last
branch outcome only is used to index to the BHT. How many mis-predictions are
there and which of the branches in this sequence would be mis-predicted? Fill
up the table for 16 branch outcomes.</p>
<p>Ans:
<img src="./images/pipeline-hazards-solution3.png" alt="pipeline-hazards-solution3" /> </p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../computer-architecture/3.intro-to-risc.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../computer-architecture/6.compiler-techniques.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../computer-architecture/3.intro-to-risc.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../computer-architecture/6.compiler-techniques.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
